# Starter pipeline
#

trigger:
  branches:
    include:
      - release
      - develop
      - DATA-*
  paths:
    include:
      - /engine/alg-server/*
    exclude:
      - /engine/graph-engine/*
      - /builder/*
      - /sdk/*

pool:
  name: algServer

parameters:
  - name: pushTag
    displayName: 是否要推送到harbor
    type: boolean
    default: false

variables:
  - group: global-context
  - name: imageTag
    value: $(Build.SourceBranchName)-$(Build.BuildNumber)
  - name: imageName
    value: kw-algserver
  - name: UTArtifactName
    value: coverageFiles
  - name: imageNameWithHarbor
    value: acr.aishu.cn/ad/kw-algserver

resources:
  containers:
    - container: scanner
      endpoint: acr.aishu.cn
      image: ad/openjdk:11.0.13-jre
    - container: dotnet
      endpoint: acr.aishu.cn
      image: wing-biz/euop/dotnet-runtime:3.1

jobs:
  - job:
    displayName: build
    workspace:
      clean: all
    steps:
    - task: Docker@2
      displayName: buildImage
      inputs:
        command: 'build'
        repository: $(imageNameWithHarbor)
        tags: |
          $(kwTag)
          latest
        Dockerfile: '**/Algserver.Dockerfile'
    - task: Docker@2
      inputs:
        containerRegistry: 'acr.aishu.cn'
        command: 'login'
    - task: Docker@2
      displayName: Push image
      condition: and(succeeded(), eq(${{ parameters.pushTag }}, 'True'))
      inputs:
        containerRegistry: 'acr.aishu.cn'
        repository: 'ad/kw-algserver'
        command: push
        tags: |
          $(kwTag)
          latest
    - task: Bash@3
      displayName: saveTar
      inputs:
        targetType: 'inline'
        script: |
          docker save -o KWeaver-$(kwTag)-kw-algserver-$(imageTag).tar $(imageNameWithHarbor):$(kwTag)
    - task: FtpUpload@2
      displayName: uploadFtp
      inputs:
        credentialsOption: 'inputs'
        serverUrl: 'ftp://ftp-ad.aishu.cn'
        username: '$(ftpUser)'
        password: '$(ftpPasswd)'
        rootDirectory:
        filePatterns: '**/KWeaver-$(kwTag)-kw-algserver-$(imageTag).tar'
        remoteDirectory: '/packages/$(imageName)/$(Build.SourceBranchName)'
        clean: false
        cleanContents: false
        preservePaths: false
        trustSSL: false
